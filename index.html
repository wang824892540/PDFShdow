<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PDF Processor</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>功能导航</h2>
      </div>
      <nav>
        <ul>
          <li><a href="#" class="nav-link active" data-view="sheinLabelView">Shein Label 生成</a></li>
          <li><a href="#" class="nav-link" data-view="pdfResizeView">PDF 尺寸调整</a></li>
        </ul>
      </nav>
      <button id="themeToggleBtn" title="切换主题"></button>
    </aside>

    <main class="main-content">
      <div class="view-container" id="pdfResizeView" style="display: none;">
        <!-- Existing content will be wrapped by its own .container if needed, or styled directly -->
        <div class="container"> <!-- This is the original .container -->
          <h2>PDF 尺寸调整</h2>
          
          <div class="section">
            <div class="field-wrapper"> <!-- Added wrapper for layout with error message -->
              <button id="openFile" class="btn-primary">选择 PDF 文件</button>
              <span id="selectedFile" class="file-select-status-span"></span>
              <small class="error-message" id="selectedFileError"></small> <!-- New error message placeholder -->
            </div>
          </div>
      
          <div class="section">
            <label for="pdfResizeOutputName">输出文件名称:</label>
            <input type="text" id="pdfResizeOutputName" placeholder="例如: resized_document">
          </div>
      
          <div class="section">
            <label for="pageSize">页面尺寸调整</label>
            <select id="pageSize">
              <option value="A4">A4 (210x297mm)</option>
              <option value="Letter">Letter (215.9x279.4mm)</option>
              <option value="Shein" selected>Shein (70x60mm)</option>
              <option value="custom">自定义</option>
            </select>
            <div id="customSize" class="dimension-inputs-container" style="display: none;">
              <div class="field-wrapper">
                <div class="input-group">
                  <input type="number" id="customWidth" placeholder="宽度">
                  <span class="unit">mm</span>
                </div>
                <small class="error-message" id="customWidthError"></small>
              </div>
              <div class="field-wrapper">
                <div class="input-group">
                  <input type="number" id="customHeight" placeholder="高度">
                  <span class="unit">mm</span>
                </div>
                <small class="error-message" id="customHeightError"></small>
              </div>
            </div>
          </div>
      
          <div class="action-buttons-row" style="display: flex; margin-bottom: 10px;">
            <button id="processBtn" class="btn-primary">开始处理</button> <!-- Removed flex-grow: 1 -->
            <button id="clearPdfResizeFormBtn" class="btn-secondary" style="margin-left: 10px;">清空</button>
          </div>
          <div id="result"></div>
<div id="pdfResizePostProcessActions" style="margin-top: 10px; display: none;">
            <button id="pdfResizeOpenGeneratedFileBtn" class="action-button">打开文件</button>
            <button id="pdfResizeShowGeneratedFileInFolderBtn" class="action-button">打开文件夹</button>
            <button id="pdfResizeCopyFileBtn" class="action-button" title="尝试复制文件到剪贴板 (若失败则复制路径)">复制文件</button>
          </div>
        </div>
      </div>

      <div class="view-container" id="sheinLabelView" style="display: block;">
        <div class="container"> <!-- Each view can have its own container for consistency -->
          <h2>Shein Label 生成</h2>
          
          <div class="section">
            <div class="field-wrapper"> <!-- Added wrapper -->
              <button id="sheinOpenFile1Btn" class="btn-primary">选择欧代文件</button>
              <span id="sheinSelectedFile1" class="file-select-status-span">未选择文件</span>
              <small class="error-message" id="sheinSelectedFile1Error"></small> <!-- New error message placeholder -->
            </div>
          </div>

          <div class="section">
            <div class="field-wrapper"> <!-- Added wrapper -->
              <button id="sheinOpenFile2Btn" class="btn-primary">选择条码文件</button>
              <span id="sheinSelectedFile2" class="file-select-status-span">未选择文件</span>
              <small class="error-message" id="sheinSelectedFile2Error"></small> <!-- New error message placeholder -->
            </div>
          </div>

          <div class="section">
            <label for="sheinOutputName">输出文件名称:</label>
            <input type="text" id="sheinOutputName" placeholder="例如: shein_label_output">
          </div>

          <div class="section">
            <label for="sheinOutputPageSize">输出页面尺寸 (mm):</label>
            <select id="sheinOutputPageSize">
              <option value="A4">A4 (210x297mm)</option>
              <option value="Letter">Letter (215.9x279.4mm)</option>
              <option value="Shein" selected>Shein (70x60mm)</option>
              <option value="custom">自定义</option>
            </select>
            <div id="sheinOutputCustomDimensions" class="dimension-inputs-container" style="display: none;">
              <div class="field-wrapper">
                <div class="input-group">
                  <input type="number" id="sheinOutputWidth" placeholder="宽度" value="70">
                  <span class="unit">mm</span>
                </div>
                <small class="error-message" id="sheinOutputWidthError"></small>
              </div>
              <div class="field-wrapper">
                <div class="input-group">
                  <input type="number" id="sheinOutputHeight" placeholder="高度" value="60">
                  <span class="unit">mm</span>
                </div>
                <small class="error-message" id="sheinOutputHeightError"></small>
              </div>
            </div>
          </div>

          <div class="action-buttons-row" style="display: flex; margin-bottom: 10px;">
            <button id="generateSheinLabelBtn" class="btn-primary">生成 Shein Label</button> <!-- Removed flex-grow: 1 -->
            <button id="clearSheinLabelFormBtn" class="btn-secondary" style="margin-left: 10px;">清空</button>
          </div>
          <div id="sheinResult"></div>
          <div id="sheinPostProcessActions" style="margin-top: 10px; display: none;">
            <button id="openGeneratedFileBtn" class="action-button">打开文件</button>
            <button id="showGeneratedFileInFolderBtn" class="action-button">打开文件夹</button>
            <button id="sheinCopyFileBtn" class="action-button" title="尝试复制文件到剪贴板 (若失败则复制路径)">复制文件</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- <script src="renderer.js"></script> -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Settings Persistence using Electron IPC ---
    // Note: saveToLocalStorage and loadFromLocalStorage are removed.
    // We will use window.electronAPI.getSettings() and window.electronAPI.saveSettings()

    let appSettings = {}; // Holds all application settings

    // --- Sidebar navigation and View Persistence ---
    const navLinks = document.querySelectorAll('.sidebar .nav-link');
    const views = document.querySelectorAll('.main-content .view-container');
    const defaultViewId = 'sheinLabelView';

    // Function to activate a view and save it
    const activateView = async (viewId) => {
      let viewActivated = false;
      views.forEach(view => {
        if (view.id === viewId) {
          view.style.display = 'block';
          viewActivated = true;
        } else {
          view.style.display = 'none';
        }
      });

      navLinks.forEach(l => {
        if (l.getAttribute('data-view') === viewId) {
          l.classList.add('active');
        } else {
          l.classList.remove('active');
        }
      });

      if (viewActivated) {
        appSettings.activeView = viewId;
        await window.electronAPI.saveSettings(appSettings);
      }
      return viewActivated;
    };
    
    navLinks.forEach(link => {
      link.addEventListener('click', async function(event) { // Made async
        event.preventDefault();
        const viewId = this.getAttribute('data-view');
        await activateView(viewId); // Made await
      });
    });

    // Helper function to get basename using pure JavaScript (as a fallback)
    function getBasenameFrontend(filePath) {
      if (!filePath || typeof filePath !== 'string') {
        return '';
      }
      // Replace all backslashes with forward slashes for consistent parsing
      const normalizedPath = filePath.replace(/\\/g, '/');
      const lastSlashIndex = normalizedPath.lastIndexOf('/');
      if (lastSlashIndex === -1) {
        return normalizedPath; // No slashes, the whole path is the filename
      }
      return normalizedPath.substring(lastSlashIndex + 1);
    }

    function formatBytes(bytes, decimals = 2) {
      if (bytes === null || bytes === undefined || isNaN(parseFloat(bytes)) || !isFinite(bytes) || bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function updateFileSelectionUI(filePath, spanElementId, pageCount = null, fileSize = null) {
      const spanElement = document.getElementById(spanElementId);
      if (!spanElement) return;

      if (filePath && typeof filePath === 'string' && filePath.trim() !== '') {
        let displayText = getBasenameFrontend(filePath);
        let details = [];
        if (pageCount !== null && pageCount !== undefined) {
          details.push(`页数: ${pageCount}`);
        }
        if (fileSize !== null && fileSize !== undefined) {
          details.push(`大小: ${formatBytes(fileSize)}`);
        }
        if (details.length > 0) {
          displayText += ` (${details.join(', ')})`;
        }
        spanElement.textContent = displayText;
        spanElement.classList.add('file-selected-badge');
      } else {
        spanElement.textContent = '未选择文件';
        spanElement.classList.remove('file-selected-badge');
      }
    }
    
    // Function to clear specific inline error associated with a file input
    function clearInlineFileError(errorElementId) {
        const errorEl = document.getElementById(errorElementId);
        if (errorEl) {
            errorEl.textContent = '';
            errorEl.style.display = 'none';
            errorEl.classList.remove('warning-text'); // Remove warning class if it was added
        }
    }


    const themeToggleBtn = document.getElementById('themeToggleBtn');
    // Theme persistence will also use appSettings
    const sunIcon = '☀️';
    const moonIcon = '🌙';

    async function setTheme(theme, save = true) { // Added save parameter
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggleBtn.textContent = sunIcon;
      } else { // Default to light
        document.body.classList.remove('dark-mode');
        themeToggleBtn.textContent = moonIcon;
      }
      if (save) {
        appSettings.theme = theme;
        await window.electronAPI.saveSettings(appSettings);
      }
    }

    themeToggleBtn.addEventListener('click', async () => {
      const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      await setTheme(newTheme);
    });

    // Function to show toast notifications
    function showToast(message, type = 'info', duration = 3500) {
      const container = document.getElementById('toastContainer');
      if (!container) {
        console.error('Toast container not found!');
        return;
      }

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`; // e.g., "toast toast-success"
    
      // --- Add logging and default message for debugging ---
      console.log(`showToast called with message: "${message}", type: "${type}"`);
      const displayMessage = (message && typeof message === 'string' && message.trim() !== '') ? message : "[默认测试提示]";
      toast.textContent = displayMessage;
      // --- End of debugging addition ---
    
      container.appendChild(toast);

      // Remove the toast after its animation finishes
      // The 'duration' parameter (default 3500ms) is how long the toast stays fully visible
      // before starting to fade out.
      const fadeOutAnimationDuration = 400; // Must match the CSS animation duration for .fade-out (0.4s)

      setTimeout(() => {
        toast.classList.add('fade-out'); // Add class to trigger CSS fade-out animation

        // Remove the toast from DOM after the fade-out animation completes
        setTimeout(() => {
          if (toast.parentNode === container) {
            container.removeChild(toast);
          }
        }, fadeOutAnimationDuration);
      }, duration); // 'duration' is when the fade-out should start
    }

    // --- Standardized Error Handling for Toasts ---
    /**
     * Handles API errors and displays a standardized toast message.
     * @param {object} apiResult - The result object from an API call, expected to have an 'error' property if failed.
     * @param {string} featureName - The name of the feature where the error occurred (e.g., "PDF尺寸调整").
     * @param {string} [defaultApiErrorMsg='操作失败。请检查文件或设置，然后重试。'] - Default message if apiResult.error is not specific.
     * @param {HTMLElement|null} [resultDiv=null] - Optional result div to clear/hide.
     * @param {HTMLElement|null} [postProcessActionsDiv=null] - Optional post-process actions div to hide.
     */
    function handleAndShowApiError(apiResult, featureName, defaultApiErrorMsg = '操作失败。请检查文件或设置，然后重试。', resultDiv = null, postProcessActionsDiv = null) {
      const errorMessage = (apiResult && apiResult.error) ? apiResult.error : defaultApiErrorMsg;
      showToast(`${featureName}失败：${errorMessage}`, 'error');
      if (resultDiv) {
        resultDiv.innerHTML = '';
        resultDiv.style.display = 'none';
        resultDiv.className = '';
      }
      if (postProcessActionsDiv) {
        postProcessActionsDiv.style.display = 'none';
      }
    }

    /**
     * Handles client-side JavaScript errors and displays a standardized toast message.
     * @param {Error} errorObject - The JavaScript Error object.
     * @param {string} featureName - The name of the feature where the error occurred.
     * @param {string} [defaultClientErrorMsg='客户端发生意外错误，请重试。'] - Default message if errorObject.message is not specific.
     * @param {HTMLElement|null} [resultDiv=null] - Optional result div to clear/hide and show client error.
     * @param {HTMLElement|null} [postProcessActionsDiv=null] - Optional post-process actions div to hide.
     */
    function handleAndShowClientError(errorObject, featureName, defaultClientErrorMsg = '客户端发生意外错误，请重试。', resultDiv = null, postProcessActionsDiv = null) {
      const errorMessage = errorObject.message ? errorObject.message : defaultClientErrorMsg;
      showToast(`${featureName}出错：${errorMessage}`, 'error');
      if (resultDiv) {
        resultDiv.innerHTML = `<p>客户端错误: ${errorMessage}</p>`;
        resultDiv.className = 'error';
        resultDiv.style.display = 'block';
      }
      if (postProcessActionsDiv) {
        postProcessActionsDiv.style.display = 'none';
      }
    }
    // --- End Standardized Error Handling ---

    // --- Listener for Toasts from Main Process ---
    if (window.electronAPI && typeof window.electronAPI.onShowToast === 'function') {
      window.electronAPI.onShowToast((message, type, duration) => {
        showToast(message, type, duration);
      });
    } else {
      console.error('Error: window.electronAPI.onShowToast is not available. Toasts from main process will not be shown.');
    }
    // --- End Listener for Toasts from Main Process ---

    // For PDF Resize View Post-Process Actions
    const pdfResizePostProcessActionsDiv = document.getElementById('pdfResizePostProcessActions');
    const pdfResizeOpenGeneratedFileBtn = document.getElementById('pdfResizeOpenGeneratedFileBtn');
    const pdfResizeShowGeneratedFileInFolderBtn = document.getElementById('pdfResizeShowGeneratedFileInFolderBtn');
    const pdfResizeCopyFileBtn = document.getElementById('pdfResizeCopyFileBtn');
    let currentGeneratedPdfResizePath = ''; // To store the path for these buttons

    const pageSizeMap = {
      'A4': { width: 210 * 2.835, height: 297 * 2.835 }, // mm转pt
      'Letter': { width: 215.9 * 2.835, height: 279.4 * 2.835 },
      'Shein': { width: 70 * 2.835, height: 60 * 2.835 }, // mm转pt
      'custom': null
    }

    const pageSizeMapMM = { // For populating MM inputs
      'A4': { width: 210, height: 297 },
      'Letter': { width: 215.9, height: 279.4 },
      'Shein': { width: 70, height: 60 }
    };

    let selectedFilePath = ''

    document.getElementById('openFile').addEventListener('click', async () => {
      const newPath = await window.electronAPI.openFile();
      const selectedFileErrorEl = document.getElementById('selectedFileError');
      const openFileButton = document.getElementById('openFile');

      if (!newPath) {
        showToast('操作已取消，未选择任何文件。', 'info');
        // If a file was previously selected, and now cancelled, selectedFilePath might still hold old path.
        // We should update UI to "未选择文件" if cancellation truly means no file.
        // If selectedFilePath is already empty or user cancels, updateFileSelectionUI will handle it.
        // No specific metadata fetch needed if no new path.
        updateFileSelectionUI(selectedFilePath, 'selectedFile'); // Update with current selectedFilePath (might be old or empty)
      } else {
        selectedFilePath = newPath;
        appSettings.pdfResizeSelectedPath = selectedFilePath;
        try {
          const metadata = await window.electronAPI.getPdfMetadata(selectedFilePath);
          if (metadata.success) {
            updateFileSelectionUI(selectedFilePath, 'selectedFile', metadata.pageCount, metadata.size);
            if (openFileButton) openFileButton.classList.remove('input-error');
            if (selectedFileErrorEl) {
                selectedFileErrorEl.textContent = '';
                selectedFileErrorEl.style.display = 'none';
            }
          } else {
            showToast(`无法读取文件元数据: ${metadata.error || '未知错误'}`, 'error');
            updateFileSelectionUI(selectedFilePath, 'selectedFile'); // Show filename at least
          }
        } catch (err) {
          showToast(`获取文件元数据时出错: ${err.message}`, 'error');
          updateFileSelectionUI(selectedFilePath, 'selectedFile'); // Show filename at least
        }
        const saveResult = await window.electronAPI.saveSettings(appSettings);
        if (!saveResult || !saveResult.success) {
          console.error('Failed to save settings after PDF Resize file selection:', saveResult ? saveResult.error : 'Unknown error');
          showToast('警告：无法保存文件选择设置。', 'warning');
        }
      }
      // If newPath is null (cancelled), selectedFilePath might still hold the previous value.
      // The UI update for "未选择文件" is handled by updateFileSelectionUI if selectedFilePath becomes empty.
      // If user cancels, and selectedFilePath was already empty, updateFileSelectionUI will show "未选择文件".
      // If user cancels, and selectedFilePath had a value, it will still show that old file's info
      // unless we explicitly clear selectedFilePath here on cancel.
      // For now, let's assume cancelling means "keep the last valid selection or show '未选择文件' if none".
      // The error clearing logic for the button itself is handled above if a new file is successfully processed.
    })

    // Initialize the badge state on load - this will be handled by loadAndApplySettings
    // const initialSelectedFileElement = document.getElementById('selectedFile');
    // if (!selectedFilePath) {
    //     initialSelectedFileElement.textContent = '未选择文件';
    //     initialSelectedFileElement.classList.remove('file-selected-badge');
    // }


    document.getElementById('pageSize').addEventListener('change', async function() { // Added async
      const customSizeEl = document.getElementById('customSize');
      if (this.value === 'custom') {
        customSizeEl.style.display = 'flex'; // Ensure it's flex for layout
      } else {
        customSizeEl.style.display = 'none';
      }
      appSettings.pageSize = this.value;
      await window.electronAPI.saveSettings(appSettings);
    })
    // Ensure sheinOutputCustomSize is flex by default if it's always visible
    // Or add a similar JS logic if it needs to be toggled. For now, CSS will handle it.

    // Add event listeners to custom dimension inputs for PDF Resize to clear errors on valid input
    const customWidthInput = document.getElementById('customWidth');
    const customHeightInput = document.getElementById('customHeight');
    const customWidthErrorEl = document.getElementById('customWidthError');
    const customHeightErrorEl = document.getElementById('customHeightError');

    if (customWidthInput && customWidthErrorEl) {
      customWidthInput.addEventListener('input', () => {
        const widthVal = parseFloat(customWidthInput.value);
        if (!isNaN(widthVal) && widthVal > 0) {
          customWidthInput.classList.remove('input-error');
          customWidthErrorEl.textContent = '';
          customWidthErrorEl.style.display = 'none';
        }
      });
    }

    if (customHeightInput && customHeightErrorEl) {
      customHeightInput.addEventListener('input', () => {
        const heightVal = parseFloat(customHeightInput.value);
        if (!isNaN(heightVal) && heightVal > 0) {
          customHeightInput.classList.remove('input-error');
          customHeightErrorEl.textContent = '';
          customHeightErrorEl.style.display = 'none';
        }
      });
    }

    document.getElementById('processBtn').addEventListener('click', async () => {
      const processButton = document.getElementById('processBtn');
      const originalButtonText = processButton.textContent;

      try {
        // Resetting file selection error state (done after global resultDiv reset and before other specific resets)
        // This will be handled by the more general reset block below.

        if (!selectedFilePath) {
        const openFileButton = document.getElementById('openFile');
        const selectedFileErrorEl = document.getElementById('selectedFileError');

        if (openFileButton) {
            openFileButton.classList.add('input-error');
            // Optionally focus the button, though it might be disruptive
            // openFileButton.focus();
        }
        const errorMessage = '请先选择一个 PDF 文件。';
        showToast(errorMessage, 'error'); // Added toast notification
        if (selectedFileErrorEl) {
            selectedFileErrorEl.textContent = errorMessage;
            selectedFileErrorEl.style.display = 'block';
        } else {
            // Fallback if the error element itself is somehow missing
            console.error("PDF Resize Error: selectedFileError element not found in DOM!");
            // Toast already shown, so no need for resultDiv fallback for this specific message
        }
        return;
      }

      const operations = {}
      const pdfResizeOutputNameInput = document.getElementById('pdfResizeOutputName');

      // Reset/hide post-process actions for pdfResizeView at the start of processing
      if (pdfResizePostProcessActionsDiv) {
          pdfResizePostProcessActionsDiv.style.display = 'none';
      }
      currentGeneratedPdfResizePath = '';
      const resultDivForReset = document.getElementById('result'); // Global result div
      if (resultDivForReset) {
          resultDivForReset.innerHTML = '';
          resultDivForReset.className = '';
          resultDivForReset.style.display = 'none'; // Hide global result div when resetting
      }
      // Also reset custom dimension inline errors here if they were shown from a previous attempt
      const widthInputForReset = document.getElementById('customWidth');
      const heightInputForReset = document.getElementById('customHeight');
      const customWidthErrorElForReset = document.getElementById('customWidthError');
      const customHeightErrorElForReset = document.getElementById('customHeightError');

      if (widthInputForReset && customWidthErrorElForReset) {
          widthInputForReset.classList.remove('input-error');
          customWidthErrorElForReset.textContent = '';
          customWidthErrorElForReset.style.display = 'none';
      }
      if (heightInputForReset && customHeightErrorElForReset) {
          heightInputForReset.classList.remove('input-error');
          customHeightErrorElForReset.textContent = '';
          customHeightErrorElForReset.style.display = 'none';
      }
      // Also reset file selection error state here
      const openFileButtonForReset = document.getElementById('openFile');
      const selectedFileErrorForReset = document.getElementById('selectedFileError');
      if (openFileButtonForReset && selectedFileErrorForReset) {
          openFileButtonForReset.classList.remove('input-error');
          selectedFileErrorForReset.textContent = '';
          selectedFileErrorForReset.style.display = 'none';
      }

      function getCurrentHHMMSS() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${hours}${minutes}${seconds}`;
      }

      let outputName = pdfResizeOutputNameInput.value.trim();
      if (!outputName) {
        outputName = `resized_${getCurrentHHMMSS()}.pdf`;
      } else if (!outputName.toLowerCase().endsWith('.pdf')) {
        outputName += '.pdf';
      }
      
      // 获取尺寸参数
      const sizeType = document.getElementById('pageSize').value
      if (sizeType !== 'custom') {
        operations.resize = pageSizeMap[sizeType]
      } else {
        const widthInput = document.getElementById('customWidth');
        const heightInput = document.getElementById('customHeight');
        const customWidthErrorEl = document.getElementById('customWidthError');
        const customHeightErrorEl = document.getElementById('customHeightError');

        let validationPassed = true;
        let width = NaN;
        let height = NaN;

        if (widthInput) {
            width = parseFloat(widthInput.value);
        } else {
            console.error("PDF Resize Error: customWidth input element not found in DOM.");
            validationPassed = false; // Critical element missing
        }

        if (heightInput) {
            height = parseFloat(heightInput.value);
        } else {
            console.error("PDF Resize Error: customHeight input element not found in DOM.");
            validationPassed = false; // Critical element missing
        }
        
        // Proceed with validation only if critical elements were found for parsing
        if (validationPassed) {
            console.log(`Initial validation for width: ${width}, height: ${height}`);
            if (isNaN(width) || width <= 0) {
                console.log(`Width validation failed. Value: ${width}`);
                if (widthInput) {
                    console.log(`Attempting to style widthInput (ID: ${widthInput.id}). Current background: ${widthInput.style.backgroundColor}, Classes: ${widthInput.className}`);
                    heightInput.classList.add('input-error');
                    widthInput.classList.add('input-error');
                    console.log(`After styling widthInput. New background: ${widthInput.style.backgroundColor}, New classes: ${widthInput.className}`);
                    widthInput.focus();
                }
                const widthErrorMessage = '宽度必须是有效的正数。';
                showToast(widthErrorMessage, 'error');
                if (customWidthErrorEl) {
                    console.log(`Attempting to show customWidthErrorEl (ID: ${customWidthErrorEl.id}). Current display: ${customWidthErrorEl.style.display}`);
                    customWidthErrorEl.textContent = widthErrorMessage;
                    customWidthErrorEl.style.display = 'block';
                    console.log(`After showing customWidthErrorEl. New display: ${customWidthErrorEl.style.display}, Text: ${customWidthErrorEl.textContent}`);
                } else {
                    console.error("PDF Resize Error: customWidthError element not found for displaying message.");
                }
                validationPassed = false;
                console.log(`Set validationPassed to false due to invalid width.`);
            }

            if (isNaN(height) || height <= 0) {
                console.log(`Height validation failed. Value: ${height}`);
                if (heightInput) {
                    console.log(`Attempting to style heightInput (ID: ${heightInput.id}). Current background: ${heightInput.style.backgroundColor}, Classes: ${heightInput.className}`);
                    widthInput.classList.add('input-error'); // Diagnostic style change
                    heightInput.classList.add('input-error');
                    console.log(`After styling heightInput. New background: ${heightInput.style.backgroundColor}, New classes: ${heightInput.className}`);
                    if (validationPassed && widthInput) {
                        heightInput.focus();
                    } else if (!widthInput && heightInput) {
                        heightInput.focus();
                    } else if (heightInput && !widthInput) { // If width was invalid but widthInput itself was missing
                        heightInput.focus();
                    } else if (validationPassed && !widthInput) { // If width was considered valid (e.g. not NaN) but widthInput was missing
                         heightInput.focus(); // Focus height if it's the first actual input field with an error
                    } else if (!validationPassed && heightInput) { // If width validation failed, and now height is also failing
                        // Let width keep focus if it was set, otherwise focus height if widthInput was missing
                        if(document.activeElement !== widthInput) heightInput.focus();
                    }


                }
                const heightErrorMessage = '高度必须是有效的正数。';
                showToast(heightErrorMessage, 'error');
                if (customHeightErrorEl) {
                    console.log(`Attempting to show customHeightErrorEl (ID: ${customHeightErrorEl.id}). Current display: ${customHeightErrorEl.style.display}`);
                    customHeightErrorEl.textContent = heightErrorMessage;
                    customHeightErrorEl.style.display = 'block';
                    console.log(`After showing customHeightErrorEl. New display: ${customHeightErrorEl.style.display}, Text: ${customHeightErrorEl.textContent}`);
                } else {
                    console.error("PDF Resize Error: customHeightError element not found for displaying message.");
                }
                validationPassed = false;
                console.log(`Set validationPassed to false due to invalid height.`);
            }
        }

        console.log(`Final validationPassed state before return check: ${validationPassed}`);
        if (!validationPassed) {
          console.log("Validation failed (or critical elements missing), returning early from processBtn.");
          return; // Stop if elements are missing or validation fails
        }
        console.log("Validation passed, proceeding to operations.resize.");

        // If we reach here, all elements were found and validation passed
        operations.resize = {
          width: width * 2.835, // width and height are guaranteed to be valid numbers here
          height: height * 2.835
        }
      }
      // --- Show Processing State ---
      // processButton and originalButtonText are defined at the start of the event listener
      if (processButton) {
        processButton.disabled = true;
        processButton.textContent = '正在处理中...';
        processButton.classList.add('processing'); // Add processing class
      }
      // Optional: Show a processing message in resultDiv
      // const resultDivForProcessing = document.getElementById('result');
      // if (resultDivForProcessing) {
      //   resultDivForProcessing.innerHTML = '<p>正在处理，请稍候...</p>';
      //   resultDivForProcessing.className = 'info'; // Needs a .info style in CSS
      //   resultDivForProcessing.style.display = 'block';
      // }
      // --- End Show Processing State ---

      console.log('[PDF Resize] Before calling window.electronAPI.processPDF. Params:', { filePath: selectedFilePath, operations, outputName }); // DEBUG LOG
      const apiResult = await window.electronAPI.processPDF({ // Renamed to apiResult
        filePath: selectedFilePath,
        operations,
        outputName: outputName
      });
      console.log('[PDF Resize] After calling window.electronAPI.processPDF. Result:', apiResult); // DEBUG LOG

      const resultDiv = document.getElementById('result'); // Ensure it's defined before use
      if (apiResult && apiResult.success && apiResult.path) {
        showToast('处理成功！', 'success');
        if (resultDiv) {
            resultDiv.style.display = 'block';
            let resultHtml = `<p>保存路径：${apiResult.path}</p>`;
            if (apiResult.outputFileSize !== null && apiResult.outputFileSize !== undefined) {
              resultHtml += `<p>文件大小：${formatBytes(apiResult.outputFileSize)}`;
              if (apiResult.outputPageCount !== null && apiResult.outputPageCount !== undefined) {
                resultHtml += `，页数：${apiResult.outputPageCount}`;
              }
              resultHtml += `</p>`;
            } else if (apiResult.outputPageCount !== null && apiResult.outputPageCount !== undefined) {
              resultHtml += `<p>页数：${apiResult.outputPageCount}</p>`;
            }
            if(apiResult.metadataError){
                resultHtml += `<p style="color: orange;">输出文件元数据警告: ${apiResult.metadataError}</p>`;
            }
            resultDiv.innerHTML = resultHtml;
            resultDiv.className = 'success';
        }
        currentGeneratedPdfResizePath = apiResult.path;
        if (pdfResizePostProcessActionsDiv) {
            pdfResizePostProcessActionsDiv.style.display = 'block';
        }
      } else {
        handleAndShowApiError(apiResult, 'PDF尺寸调整', undefined, resultDiv, pdfResizePostProcessActionsDiv);
      }
    } catch (error) {
      console.error('[PDF Resize] Error in processBtn click handler:', error);
      handleAndShowClientError(error, 'PDF尺寸调整', undefined, document.getElementById('result'), pdfResizePostProcessActionsDiv);
    } finally {
      // --- Reset Processing State ---
      // processButton and originalButtonText are defined at the start of the event listener
      if (processButton) {
          processButton.disabled = false;
          processButton.textContent = originalButtonText;
          processButton.classList.remove('processing'); // Remove processing class
      }
      // If resultDiv was used for a "processing..." message and not overwritten by success/failure,
      // it might need clearing here. However, current logic for success/failure does update resultDiv or hides it.
    }
    })

    // PDF Resize View - Clear Form Button
    const clearPdfResizeFormBtn = document.getElementById('clearPdfResizeFormBtn');
    if (clearPdfResizeFormBtn) {
      clearPdfResizeFormBtn.addEventListener('click', async () => {
        // Clear file selection
        selectedFilePath = '';
        updateFileSelectionUI(selectedFilePath, 'selectedFile', null, null); // Pass nulls for metadata
        appSettings.pdfResizeSelectedPath = '';
        const openFileButton = document.getElementById('openFile');
        const selectedFileErrorEl = document.getElementById('selectedFileError');
        if (openFileButton) openFileButton.classList.remove('input-error');
        if (selectedFileErrorEl) {
          selectedFileErrorEl.textContent = '';
          selectedFileErrorEl.style.display = 'none';
        }

        // Clear output name
        const pdfResizeOutputNameInput = document.getElementById('pdfResizeOutputName');
        if (pdfResizeOutputNameInput) pdfResizeOutputNameInput.value = '';
        appSettings.pdfResizeOutputName = '';

        // Reset page size
        const pageSizeSelect = document.getElementById('pageSize');
        if (pageSizeSelect) pageSizeSelect.value = 'Shein'; // Default to Shein
        appSettings.pageSize = 'Shein';
        const customSizeEl = document.getElementById('customSize');
        if (customSizeEl) customSizeEl.style.display = 'none';
        
        // Clear custom dimensions and their errors
        const customWidthInput = document.getElementById('customWidth');
        const customHeightInput = document.getElementById('customHeight');
        const customWidthErrorEl = document.getElementById('customWidthError');
        const customHeightErrorEl = document.getElementById('customHeightError');
        if (customWidthInput) {
          customWidthInput.value = '';
          customWidthInput.classList.remove('input-error');
        }
        if (customWidthErrorEl) {
          customWidthErrorEl.textContent = '';
          customWidthErrorEl.style.display = 'none';
        }
        appSettings.customWidth = '';

        if (customHeightInput) {
          customHeightInput.value = '';
          customHeightInput.classList.remove('input-error');
        }
        if (customHeightErrorEl) {
          customHeightErrorEl.textContent = '';
          customHeightErrorEl.style.display = 'none';
        }
        appSettings.customHeight = '';

        // Clear result and post-process actions
        const resultDiv = document.getElementById('result');
        if (resultDiv) {
          resultDiv.innerHTML = '';
          resultDiv.className = '';
          resultDiv.style.display = 'none';
        }
        if (pdfResizePostProcessActionsDiv) {
          pdfResizePostProcessActionsDiv.style.display = 'none';
        }
        currentGeneratedPdfResizePath = '';

        await window.electronAPI.saveSettings(appSettings);
        showToast('PDF 尺寸调整表单已清空', 'info');
      });
    }

    // Event listeners for PDF Resize Post-Process Actions
    if (pdfResizeOpenGeneratedFileBtn) {
        pdfResizeOpenGeneratedFileBtn.addEventListener('click', async () => {
            if (currentGeneratedPdfResizePath) {
                try {
                    await window.electronAPI.openPath(currentGeneratedPdfResizePath);
                } catch (err) {
                    console.error("Error opening file (PDF Resize):", err);
                    const openFileErrorMsg = `无法打开生成的 PDF 文件。请检查文件是否存在或是否有权限访问。 (错误: ${err.message})`;
                    showToast(openFileErrorMsg, 'error');
                }
            }
        });
    }

    if (pdfResizeShowGeneratedFileInFolderBtn) {
        pdfResizeShowGeneratedFileInFolderBtn.addEventListener('click', async () => {
            if (currentGeneratedPdfResizePath) {
                try {
                    await window.electronAPI.showItemInFolder(currentGeneratedPdfResizePath);
                } catch (err) {
                    console.error("Error showing item in folder (PDF Resize):", err);
                    const showInFolderErrorMsg = `无法在文件夹中显示该文件。请检查路径是否有效。 (错误: ${err.message})`;
                    showToast(showInFolderErrorMsg, 'error');
                }
            }
        });
    }

    if (pdfResizeCopyFileBtn) {
        pdfResizeCopyFileBtn.addEventListener('click', async () => {
            if (currentGeneratedPdfResizePath) {
                try {
                    // Assuming window.electronAPI.copyFileToClipboard will be implemented
                    // and will return an object like { success: true } or { success: false, error: 'message' }
                    const copyResult = await window.electronAPI.copyFileToClipboard(currentGeneratedPdfResizePath);
                    
                    if (copyResult && copyResult.success) {
                        if (copyResult.action === 'path_copied_unexpected_fallback') {
                            showToast(copyResult.message || '未能复制文件本身，已改为复制文件路径至剪贴板。', 'warning', 5000);
                        } else {
                            showToast('文件已复制到剪贴板！', 'success');
                        }
                        console.log('Copy action result (PDF Resize):', copyResult);
                    } else {
                        const defaultCopyError = '请检查文件是否存在或剪贴板权限。';
                        const errorMessage = `复制文件失败: ${(copyResult && copyResult.error) ? copyResult.error : defaultCopyError}`;
                        console.error("Failed to copy file to clipboard (PDF Resize):", errorMessage);
                        showToast(errorMessage, 'error');
                    }
                } catch (err) {
                    console.error("Error during copy file operation (PDF Resize):", err);
                    const exceptionCopyErrorMsg = `复制文件时发生意外错误。 (错误: ${err.message})`;
                    showToast(exceptionCopyErrorMsg, 'error');
                }
            }
        });
    }

    // --- Shein Label Feature ---
    let selectedSheinPdf1Path = '';
    let selectedSheinPdf2Path = '';

    const sheinOpenFile1Btn = document.getElementById('sheinOpenFile1Btn');
    const sheinSelectedFile1Element = document.getElementById('sheinSelectedFile1');
    const sheinOpenFile2Btn = document.getElementById('sheinOpenFile2Btn');
    const sheinSelectedFile2Element = document.getElementById('sheinSelectedFile2');
    const generateSheinLabelBtn = document.getElementById('generateSheinLabelBtn');
    const sheinResultDiv = document.getElementById('sheinResult');
    const sheinOutputNameInput = document.getElementById('sheinOutputName');
    const sheinOutputPageSizeSelect = document.getElementById('sheinOutputPageSize'); // New select
    const sheinOutputCustomDimensionsDiv = document.getElementById('sheinOutputCustomDimensions'); // New div for custom inputs
    const sheinOutputWidthInput = document.getElementById('sheinOutputWidth'); // Existing input, now inside new div
    const sheinOutputHeightInput = document.getElementById('sheinOutputHeight'); // Existing input, now inside new div
    const sheinPostProcessActionsDiv = document.getElementById('sheinPostProcessActions');
    const openGeneratedFileBtn = document.getElementById('openGeneratedFileBtn'); // Note: These are generic IDs, ensure they are scoped correctly or made specific
    const showGeneratedFileInFolderBtn = document.getElementById('showGeneratedFileInFolderBtn'); // Same as above
    const sheinCopyFileBtn = document.getElementById('sheinCopyFileBtn'); // New button for Shein copy
    let currentGeneratedSheinLabelPath = ''; // To store the path for the buttons

    // Logic for Shein output page size selection
    if (sheinOutputPageSizeSelect) {
      sheinOutputPageSizeSelect.addEventListener('change', async function() { // Added async
        if (this.value === 'custom') {
          sheinOutputCustomDimensionsDiv.style.display = 'flex';
        } else {
          sheinOutputCustomDimensionsDiv.style.display = 'none';
          const selectedSizeMM = pageSizeMapMM[this.value];
          if (selectedSizeMM) {
            sheinOutputWidthInput.value = selectedSizeMM.width;
            sheinOutputHeightInput.value = selectedSizeMM.height;
          }
        }
        appSettings.sheinOutputPageSize = this.value;
        await window.electronAPI.saveSettings(appSettings);
      });
      // Trigger change on load to set initial state based on default "Shein" selection
      // This will hide custom inputs and ensure width/height inputs are 70/60
      // (though HTML value attributes already set them, this ensures consistency if default changes)
      // This logic will be handled by the general form loading logic later
    }

    // Old default dimension setting for Shein Label (lines 443-448) is now removed
    // as it's handled by the select logic and HTML value attributes.

    // Add event listeners to custom dimension inputs for Shein Label to clear errors on valid input
    const sheinOutputWidthErrorEl = document.getElementById('sheinOutputWidthError'); // Already got this for validation
    const sheinOutputHeightErrorEl = document.getElementById('sheinOutputHeightError'); // Already got this for validation

    if (sheinOutputWidthInput && sheinOutputWidthErrorEl) {
      sheinOutputWidthInput.addEventListener('input', () => {
        const widthVal = parseFloat(sheinOutputWidthInput.value);
        if (!isNaN(widthVal) && widthVal > 0) {
          sheinOutputWidthInput.classList.remove('input-error');
          sheinOutputWidthErrorEl.textContent = '';
          sheinOutputWidthErrorEl.style.display = 'none';
        }
      });
    }

    if (sheinOutputHeightInput && sheinOutputHeightErrorEl) {
      sheinOutputHeightInput.addEventListener('input', () => {
        const heightVal = parseFloat(sheinOutputHeightInput.value);
        if (!isNaN(heightVal) && heightVal > 0) {
          sheinOutputHeightInput.classList.remove('input-error');
          sheinOutputHeightErrorEl.textContent = '';
          sheinOutputHeightErrorEl.style.display = 'none';
        }
      });
    }

    // Apply file-selected-badge styling if needed (assuming styles.css has this class)
    // Ensure initial placeholder text
    if (sheinSelectedFile1Element) sheinSelectedFile1Element.textContent = '未选择文件';
    if (sheinSelectedFile2Element) sheinSelectedFile2Element.textContent = '未选择文件';


    if (sheinOpenFile1Btn) {
      sheinOpenFile1Btn.addEventListener('click', async () => {
        const newPath = await window.electronAPI.openFile();
        const sheinSelectedFile1ErrorEl = document.getElementById('sheinSelectedFile1Error');
        const sheinOpenFile1Button = document.getElementById('sheinOpenFile1Btn');
        
        // Always clear previous specific warning for EC Rep page count
        if (sheinSelectedFile1ErrorEl) {
            clearInlineFileError('sheinSelectedFile1Error');
        }

        if (!newPath) {
          showToast('操作已取消，未选择任何文件。', 'info');
          updateFileSelectionUI(selectedSheinPdf1Path, 'sheinSelectedFile1'); // Update with current (possibly old or empty)
        } else {
          selectedSheinPdf1Path = newPath;
          appSettings.sheinEcRepPdfPath = selectedSheinPdf1Path;
          try {
            const metadata = await window.electronAPI.getPdfMetadata(selectedSheinPdf1Path);
            if (metadata.success) {
              updateFileSelectionUI(selectedSheinPdf1Path, 'sheinSelectedFile1', metadata.pageCount, metadata.size);
              if (sheinOpenFile1Button) sheinOpenFile1Button.classList.remove('input-error');
              // No need to clear general error here, as it's for file selection, not page count.
              // The specific page count warning is handled below.

              if (metadata.pageCount !== null && metadata.pageCount !== 1) {
                const warningMsg = `警告：欧代文件通常为1页。当前页数：${metadata.pageCount}`;
                showToast('请检查，欧代PDF文件通常为1页PDF', 'warning', 6000);
                if (sheinSelectedFile1ErrorEl) {
                  sheinSelectedFile1ErrorEl.textContent = warningMsg;
                  sheinSelectedFile1ErrorEl.style.display = 'block';
                  sheinSelectedFile1ErrorEl.classList.add('warning-text'); // Add class for styling
                }
              }
            } else {
              showToast(`无法读取欧代文件元数据: ${metadata.error || '未知错误'}`, 'error');
              updateFileSelectionUI(selectedSheinPdf1Path, 'sheinSelectedFile1'); // Show filename at least
            }
          } catch (err) {
            showToast(`获取欧代文件元数据时出错: ${err.message}`, 'error');
            updateFileSelectionUI(selectedSheinPdf1Path, 'sheinSelectedFile1');
          }
          const saveResult = await window.electronAPI.saveSettings(appSettings);
          if (!saveResult || !saveResult.success) {
            console.error('Failed to save settings after Shein File 1 selection:', saveResult ? saveResult.error : 'Unknown error');
            showToast('警告：无法保存文件选择设置。', 'warning');
          }
        }
      });
    }

    if (sheinOpenFile2Btn) {
      sheinOpenFile2Btn.addEventListener('click', async () => {
        const newPath = await window.electronAPI.openFile();
        const sheinOpenFile2Button = document.getElementById('sheinOpenFile2Btn');
        const sheinSelectedFile2ErrorEl = document.getElementById('sheinSelectedFile2Error');

        if (!newPath) {
          showToast('操作已取消，未选择任何文件。', 'info');
          updateFileSelectionUI(selectedSheinPdf2Path, 'sheinSelectedFile2');
        } else {
          selectedSheinPdf2Path = newPath;
          appSettings.sheinBarcodePdfPath = selectedSheinPdf2Path;
          try {
            const metadata = await window.electronAPI.getPdfMetadata(selectedSheinPdf2Path);
            if (metadata.success) {
              updateFileSelectionUI(selectedSheinPdf2Path, 'sheinSelectedFile2', metadata.pageCount, metadata.size);
              if (sheinOpenFile2Button) sheinOpenFile2Button.classList.remove('input-error');
              if (sheinSelectedFile2ErrorEl) {
                  clearInlineFileError('sheinSelectedFile2Error'); // Clear general file selection error
              }
            } else {
              showToast(`无法读取条码文件元数据: ${metadata.error || '未知错误'}`, 'error');
              updateFileSelectionUI(selectedSheinPdf2Path, 'sheinSelectedFile2');
            }
          } catch (err) {
            showToast(`获取条码文件元数据时出错: ${err.message}`, 'error');
            updateFileSelectionUI(selectedSheinPdf2Path, 'sheinSelectedFile2');
          }
          const saveResult = await window.electronAPI.saveSettings(appSettings);
          if (!saveResult || !saveResult.success) {
            console.error('Failed to save settings after Shein File 2 selection:', saveResult ? saveResult.error : 'Unknown error');
            showToast('警告：无法保存文件选择设置。', 'warning');
          }
        }
      });
    }

    if (generateSheinLabelBtn) {
      // Event listeners for open/show buttons, defined once
      openGeneratedFileBtn.addEventListener('click', async () => {
        if (currentGeneratedSheinLabelPath) {
          try {
            await window.electronAPI.openPath(currentGeneratedSheinLabelPath);
          } catch (err) {
            console.error("Error opening file (Shein Label):", err);
            const openFileErrorMsgShein = `无法打开生成的 Shein Label 文件。请检查文件是否存在或是否有权限访问。 (错误: ${err.message})`;
            showToast(openFileErrorMsgShein, 'error');
          }
        }
      });

      showGeneratedFileInFolderBtn.addEventListener('click', async () => {
        if (currentGeneratedSheinLabelPath) {
          try {
            await window.electronAPI.showItemInFolder(currentGeneratedSheinLabelPath);
          } catch (err) {
            console.error("Error showing item in folder (Shein Label):", err);
            const showInFolderErrorMsgShein = `无法在文件夹中显示该 Shein Label 文件。请检查路径是否有效。 (错误: ${err.message})`;
            showToast(showInFolderErrorMsgShein, 'error');
          }
        }
      });

      if (sheinCopyFileBtn) {
        sheinCopyFileBtn.addEventListener('click', async () => {
          if (currentGeneratedSheinLabelPath) {
            try {
              const copyResult = await window.electronAPI.copyFileToClipboard(currentGeneratedSheinLabelPath);

              if (copyResult && copyResult.success) {
                if (copyResult.action === 'path_copied_unexpected_fallback') {
                  showToast(copyResult.message || '未能复制文件本身，已改为复制文件路径至剪贴板。', 'warning', 5000);
                } else {
                  showToast('文件已复制到剪贴板！', 'success');
                }
                console.log('Copy action result (Shein Label):', copyResult);
              } else {
                const defaultCopyErrorShein = '请检查文件是否存在或剪贴板权限。';
                const errorMessage = `复制文件失败: ${(copyResult && copyResult.error) ? copyResult.error : defaultCopyErrorShein}`;
                console.error("Failed to copy file to clipboard (Shein Label):", errorMessage);
                showToast(errorMessage, 'error');
              }
            } catch (err) {
              console.error("Error during copy file operation (Shein Label):", err);
              const exceptionCopyErrorMsgShein = `复制 Shein Label 文件时发生意外错误。 (错误: ${err.message})`;
              showToast(exceptionCopyErrorMsgShein, 'error');
            }
          }
        });
      }

      generateSheinLabelBtn.addEventListener('click', async () => {
        const originalButtonText = generateSheinLabelBtn.textContent; // Store original button text
        generateSheinLabelBtn.disabled = true;
        generateSheinLabelBtn.textContent = '正在处理中...';

        sheinResultDiv.innerHTML = ''; // Clear previous results
        sheinResultDiv.className = '';
        sheinResultDiv.style.display = 'none'; // Hide when resetting
        sheinPostProcessActionsDiv.style.display = 'none'; // Hide actions at the start
        currentGeneratedSheinLabelPath = ''; // Reset path

        // Reset inline error messages for Shein file inputs
        const sheinOpenFile1ButtonForReset = document.getElementById('sheinOpenFile1Btn');
        const sheinSelectedFile1ErrorForReset = document.getElementById('sheinSelectedFile1Error');
        if (sheinOpenFile1ButtonForReset && sheinSelectedFile1ErrorForReset) {
            sheinOpenFile1ButtonForReset.classList.remove('input-error');
            sheinSelectedFile1ErrorForReset.textContent = '';
            sheinSelectedFile1ErrorForReset.style.display = 'none';
        }

        const sheinOpenFile2ButtonForReset = document.getElementById('sheinOpenFile2Btn');
        const sheinSelectedFile2ErrorForReset = document.getElementById('sheinSelectedFile2Error');
        if (sheinOpenFile2ButtonForReset && sheinSelectedFile2ErrorForReset) {
            sheinOpenFile2ButtonForReset.classList.remove('input-error');
            sheinSelectedFile2ErrorForReset.textContent = '';
            sheinSelectedFile2ErrorForReset.style.display = 'none';
        }
        // Reset inline error messages for Shein custom dimensions
        const sheinOutputWidthErrorElForReset = document.getElementById('sheinOutputWidthError');
        const sheinOutputHeightErrorElForReset = document.getElementById('sheinOutputHeightError');
        if (sheinOutputWidthInput && sheinOutputWidthErrorElForReset) {
            sheinOutputWidthInput.classList.remove('input-error');
            sheinOutputWidthErrorElForReset.textContent = '';
            sheinOutputWidthErrorElForReset.style.display = 'none';
        }
        if (sheinOutputHeightInput && sheinOutputHeightErrorElForReset) {
            sheinOutputHeightInput.classList.remove('input-error');
            sheinOutputHeightErrorElForReset.textContent = '';
            sheinOutputHeightErrorElForReset.style.display = 'none';
        }

        let sheinValidationPassed = true;

        if (!selectedSheinPdf1Path) {
          const sheinOpenFile1Button = document.getElementById('sheinOpenFile1Btn');
          const sheinSelectedFile1ErrorEl = document.getElementById('sheinSelectedFile1Error');
          const errorMessage1 = '请选择欧代文件。';
          showToast(errorMessage1, 'error');
          if (sheinOpenFile1Button) {
              sheinOpenFile1Button.classList.add('input-error');
          }
          if (sheinSelectedFile1ErrorEl) {
              sheinSelectedFile1ErrorEl.textContent = errorMessage1;
              sheinSelectedFile1ErrorEl.style.display = 'block';
          } else {
              console.error("Shein Label Error: sheinSelectedFile1Error element not found in DOM!");
              // Fallback to global error if inline element is missing
              if (sheinResultDiv) {
                  sheinResultDiv.innerHTML = '<p>请选择欧代文件 (UI Error: msg element missing)</p>';
                  sheinResultDiv.className = 'error';
                  sheinResultDiv.style.display = 'block';
              }
          }
          sheinValidationPassed = false;
        }

        if (!selectedSheinPdf2Path) {
          const sheinOpenFile2Button = document.getElementById('sheinOpenFile2Btn');
          const sheinSelectedFile2ErrorEl = document.getElementById('sheinSelectedFile2Error');
          const errorMessage2 = '请选择条码文件。';
          showToast(errorMessage2, 'error');
          if (sheinOpenFile2Button) {
              sheinOpenFile2Button.classList.add('input-error');
          }
          if (sheinSelectedFile2ErrorEl) {
              sheinSelectedFile2ErrorEl.textContent = errorMessage2;
              sheinSelectedFile2ErrorEl.style.display = 'block';
          } else {
              console.error("Shein Label Error: sheinSelectedFile2Error element not found in DOM!");
              if (sheinResultDiv) { // Fallback
                  sheinResultDiv.innerHTML = '<p>请选择条码文件 (UI Error: msg element missing)</p>';
                  sheinResultDiv.className = 'error';
                  sheinResultDiv.style.display = 'block';
              }
          }
          sheinValidationPassed = false;
        }
        
        // Validate Shein custom dimensions if "custom" is selected
        const sheinPageSizeSelectedValue = sheinOutputPageSizeSelect.value;
        let outputWidth = parseFloat(sheinOutputWidthInput.value); // Get once
        let outputHeight = parseFloat(sheinOutputHeightInput.value); // Get once
        const sheinOutputWidthErrorEl = document.getElementById('sheinOutputWidthError');
        const sheinOutputHeightErrorEl = document.getElementById('sheinOutputHeightError');

        if (sheinPageSizeSelectedValue === 'custom') {
            if (isNaN(outputWidth) || outputWidth <= 0) {
                const sheinWidthErrorMessage = '宽度必须是有效的正数。';
                showToast(sheinWidthErrorMessage, 'error');
                if (sheinOutputWidthInput) sheinOutputWidthInput.classList.add('input-error');
                if (sheinOutputWidthErrorEl) {
                    sheinOutputWidthErrorEl.textContent = sheinWidthErrorMessage;
                    sheinOutputWidthErrorEl.style.display = 'block';
                }
                if (sheinValidationPassed && sheinOutputWidthInput) sheinOutputWidthInput.focus(); // Focus if it's the first error
                sheinValidationPassed = false;
            }
            if (isNaN(outputHeight) || outputHeight <= 0) {
                const sheinHeightErrorMessage = '高度必须是有效的正数。';
                showToast(sheinHeightErrorMessage, 'error');
                if (sheinOutputHeightInput) sheinOutputHeightInput.classList.add('input-error');
                if (sheinOutputHeightErrorEl) {
                    sheinOutputHeightErrorEl.textContent = sheinHeightErrorMessage;
                    sheinOutputHeightErrorEl.style.display = 'block';
                }
                // Focus height only if width was valid or width input was missing, and height is now the error
                if (sheinValidationPassed && sheinOutputHeightInput) sheinOutputHeightInput.focus();
                else if (!sheinValidationPassed && sheinOutputWidthInput && document.activeElement !== sheinOutputWidthInput && sheinOutputHeightInput) {
                    // If width also failed, and focus is not on width input, focus height
                     sheinOutputHeightInput.focus();
                } else if (!sheinOutputWidthInput && sheinOutputHeightInput) { // If width input was missing, focus height
                    sheinOutputHeightInput.focus();
                }
                sheinValidationPassed = false;
            }
        } else {
            // If not custom, ensure values are from the selected preset (already handled by change listener, but good for robustness)
            const presetSize = pageSizeMapMM[sheinPageSizeSelectedValue];
            if (presetSize) {
                outputWidth = presetSize.width;
                outputHeight = presetSize.height;
                // No need to update input fields here as the change listener does that.
            } else {
                // This case should ideally not happen if select options are synced with pageSizeMapMM
                console.error("Shein Label: Selected preset size not found in map. Using defaults.");
                outputWidth = 70; // Fallback default
                outputHeight = 60; // Fallback default
            }
        }


        if (!sheinValidationPassed) {
          generateSheinLabelBtn.disabled = false; // Re-enable button on validation failure
          generateSheinLabelBtn.textContent = originalButtonText; // Restore original text
          generateSheinLabelBtn.classList.remove('processing'); // Also remove processing class if validation fails early
          return;
        }
        generateSheinLabelBtn.classList.add('processing'); // Add processing class - MOVED HERE

        function getCurrentHHMMSS() {
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          return `${hours}${minutes}${seconds}`;
        }

        let outputName = sheinOutputNameInput.value.trim();
        if (!outputName) {
          outputName = `SheinLabel_${getCurrentHHMMSS()}.pdf`;
          // Optionally, update the input field to show the default name to the user
          // sheinOutputNameInput.value = outputName;
        } else if (!outputName.toLowerCase().endsWith('.pdf')) {
          // Ensure .pdf extension if user provides a name without it
          outputName += '.pdf';
        }
        
        // The original check for empty outputName is now handled by the default assignment.
        // If outputNameInput was empty, it's now filled. If it had a value, it's used (and .pdf is appended if missing).
        // So, the explicit check `if (!outputName)` for emptiness before parseFloat is no longer needed here
        // as outputName will always have a value.

        // outputWidth and outputHeight are already parsed and validated (or set from preset) above.
        // No need to re-parse or re-validate here.
        
        // Prepare parameters for backend
        const params = {
          pdf1Path: selectedSheinPdf1Path,
          pdf2Path: selectedSheinPdf2Path,
          outputName: outputName,
          outputWidthMM: outputWidth, // Send as mm
          outputHeightMM: outputHeight // Send as mm
        };

        try {
          // sheinResultDiv.style.display = 'block'; // No longer showing "processing" in result div
          // sheinResultDiv.innerHTML = '<p>正在处理中...</p>'; // Removed
          const result = await window.electronAPI.generateSheinLabel(params);
          if (result.success && result.path) {
            currentGeneratedSheinLabelPath = result.path; // Store the path
            showToast('Shein Label 生成成功！', 'success');
            sheinResultDiv.style.display = 'block';
            let resultHtmlShein = `<p>保存路径：${result.path}</p>`;
            if (result.outputFileSize !== null && result.outputFileSize !== undefined) {
              resultHtmlShein += `<p>文件大小：${formatBytes(result.outputFileSize)}`;
              if (result.outputPageCount !== null && result.outputPageCount !== undefined) {
                resultHtmlShein += `，页数：${result.outputPageCount}`;
              }
              resultHtmlShein += `</p>`;
            } else if (result.outputPageCount !== null && result.outputPageCount !== undefined) {
               resultHtmlShein += `<p>页数：${result.outputPageCount}</p>`;
            }
            if(result.metadataError){
                resultHtmlShein += `<p style="color: orange;">输出文件元数据警告: ${result.metadataError}</p>`;
            }
            sheinResultDiv.innerHTML = resultHtmlShein;
            sheinResultDiv.className = 'success';
            sheinPostProcessActionsDiv.style.display = 'block';
          } else {
            handleAndShowApiError(result, 'Shein Label 生成', undefined, sheinResultDiv, sheinPostProcessActionsDiv);
          }
        } catch (error) {
          console.error('Error calling generateSheinLabel:', error);
          handleAndShowClientError(error, 'Shein Label 生成', undefined, sheinResultDiv, sheinPostProcessActionsDiv);
        } finally {
          generateSheinLabelBtn.disabled = false; // Re-enable button
          generateSheinLabelBtn.textContent = originalButtonText; // Restore original text
          generateSheinLabelBtn.classList.remove('processing'); // Remove processing class
        }
      });

    // Shein Label View - Clear Form Button
    const clearSheinLabelFormBtn = document.getElementById('clearSheinLabelFormBtn');
    if (clearSheinLabelFormBtn) {
      clearSheinLabelFormBtn.addEventListener('click', async () => {
        // Clear file selections
        selectedSheinPdf1Path = '';
        updateFileSelectionUI(selectedSheinPdf1Path, 'sheinSelectedFile1', null, null);
        appSettings.sheinEcRepPdfPath = '';
        const sheinOpenFile1Button = document.getElementById('sheinOpenFile1Btn');
        if (sheinOpenFile1Button) sheinOpenFile1Button.classList.remove('input-error');
        clearInlineFileError('sheinSelectedFile1Error'); // Clear specific EC rep warning too

        selectedSheinPdf2Path = '';
        updateFileSelectionUI(selectedSheinPdf2Path, 'sheinSelectedFile2', null, null);
        appSettings.sheinBarcodePdfPath = '';
        const sheinOpenFile2Button = document.getElementById('sheinOpenFile2Btn');
        if (sheinOpenFile2Button) sheinOpenFile2Button.classList.remove('input-error');
        clearInlineFileError('sheinSelectedFile2Error');

        // Clear output name
        if (sheinOutputNameInput) sheinOutputNameInput.value = '';
        appSettings.sheinOutputName = '';

        // Reset output page size and custom dimensions
        if (sheinOutputPageSizeSelect) sheinOutputPageSizeSelect.value = 'Shein'; // Default to Shein
        appSettings.sheinOutputPageSize = 'Shein';
        if (sheinOutputCustomDimensionsDiv) sheinOutputCustomDimensionsDiv.style.display = 'none';
        
        if (sheinOutputWidthInput) {
          sheinOutputWidthInput.value = '70'; // Default Shein width
          sheinOutputWidthInput.classList.remove('input-error');
        }
        appSettings.sheinOutputWidth = '70';
        const sheinOutputWidthErrorEl = document.getElementById('sheinOutputWidthError');
        if (sheinOutputWidthErrorEl) {
          sheinOutputWidthErrorEl.textContent = '';
          sheinOutputWidthErrorEl.style.display = 'none';
        }

        if (sheinOutputHeightInput) {
          sheinOutputHeightInput.value = '60'; // Default Shein height
          sheinOutputHeightInput.classList.remove('input-error');
        }
        appSettings.sheinOutputHeight = '60';
        const sheinOutputHeightErrorEl = document.getElementById('sheinOutputHeightError');
        if (sheinOutputHeightErrorEl) {
          sheinOutputHeightErrorEl.textContent = '';
          sheinOutputHeightErrorEl.style.display = 'none';
        }
        
        // Trigger change on select to update UI correctly (e.g., hide custom dimensions)
        if (sheinOutputPageSizeSelect) {
            const event = new Event('change', { bubbles: true });
            sheinOutputPageSizeSelect.dispatchEvent(event);
        }


        // Clear result and post-process actions
        if (sheinResultDiv) {
          sheinResultDiv.innerHTML = '';
          sheinResultDiv.className = '';
          sheinResultDiv.style.display = 'none';
        }
        if (sheinPostProcessActionsDiv) {
          sheinPostProcessActionsDiv.style.display = 'none';
        }
        currentGeneratedSheinLabelPath = '';

        await window.electronAPI.saveSettings(appSettings);
        showToast('Shein Label 生成表单已清空', 'info');
      });
    }
    }
    // --- End Shein Label Feature ---

    // --- Load All Settings and Initialize UI ---
    async function loadAndApplySettings() {
      appSettings = await window.electronAPI.getSettings();
      if (!appSettings || Object.keys(appSettings).length === 0) {
        appSettings = { // Default structure if no settings file or empty
          activeView: defaultViewId,
          theme: 'light',
          pdfResizeSelectedPath: '',
          sheinEcRepPdfPath: '',
          sheinBarcodePdfPath: '',
          pdfResizeOutputName: '',
          pageSize: 'Shein',
          customWidth: '',
          customHeight: '',
          sheinOutputName: '',
          sheinOutputPageSize: 'Shein',
          sheinOutputWidth: '70',
          sheinOutputHeight: '60'
        };
      }

      // Activate saved view or default
      if (!activateView(appSettings.activeView || defaultViewId)) {
         activateView(defaultViewId); // Fallback if saved view is invalid
      }
      
      // Set theme (without re-saving immediately)
      await setTheme(appSettings.theme || 'light', false);

      // Load selected file paths and their metadata
      selectedFilePath = appSettings.pdfResizeSelectedPath || '';
      if (selectedFilePath) {
        try {
          const metadata = await window.electronAPI.getPdfMetadata(selectedFilePath);
          updateFileSelectionUI(selectedFilePath, 'selectedFile', metadata.pageCount, metadata.size);
        } catch (e) { updateFileSelectionUI(selectedFilePath, 'selectedFile'); /* Show filename at least */ }
      } else {
        updateFileSelectionUI(null, 'selectedFile');
      }

      selectedSheinPdf1Path = appSettings.sheinEcRepPdfPath || '';
      if (selectedSheinPdf1Path) {
        try {
          const metadata = await window.electronAPI.getPdfMetadata(selectedSheinPdf1Path);
          updateFileSelectionUI(selectedSheinPdf1Path, 'sheinSelectedFile1', metadata.pageCount, metadata.size);
           // Also re-check EC Rep page count warning on load
          const sheinSelectedFile1ErrorEl = document.getElementById('sheinSelectedFile1Error');
          if (sheinSelectedFile1ErrorEl) clearInlineFileError('sheinSelectedFile1Error'); // Clear previous before check
          if (metadata.success && metadata.pageCount !== null && metadata.pageCount !== 1) {
            const warningMsg = `警告：欧代文件通常为1页。当前页数：${metadata.pageCount}`;
            // No toast on load, just inline warning
            if (sheinSelectedFile1ErrorEl) {
              sheinSelectedFile1ErrorEl.textContent = warningMsg;
              sheinSelectedFile1ErrorEl.style.display = 'block';
              sheinSelectedFile1ErrorEl.classList.add('warning-text');
            }
          }
        } catch (e) { updateFileSelectionUI(selectedSheinPdf1Path, 'sheinSelectedFile1'); }
      } else {
        updateFileSelectionUI(null, 'sheinSelectedFile1');
        clearInlineFileError('sheinSelectedFile1Error');
      }

      selectedSheinPdf2Path = appSettings.sheinBarcodePdfPath || '';
      if (selectedSheinPdf2Path) {
        try {
          const metadata = await window.electronAPI.getPdfMetadata(selectedSheinPdf2Path);
          updateFileSelectionUI(selectedSheinPdf2Path, 'sheinSelectedFile2', metadata.pageCount, metadata.size);
        } catch (e) { updateFileSelectionUI(selectedSheinPdf2Path, 'sheinSelectedFile2'); }
      } else {
        updateFileSelectionUI(null, 'sheinSelectedFile2');
      }
      
      // Load form elements
      const formElementsToPersist = [
        { id: 'pdfResizeOutputName', type: 'text' },
        { id: 'pageSize', type: 'select' },
        { id: 'customWidth', type: 'number' },
        { id: 'customHeight', type: 'number' },
        { id: 'sheinOutputName', type: 'text' },
        { id: 'sheinOutputPageSize', type: 'select' },
        { id: 'sheinOutputWidth', type: 'number' },
        { id: 'sheinOutputHeight', type: 'number' }
      ];

      formElementsToPersist.forEach(elementConfig => {
        const el = document.getElementById(elementConfig.id);
        if (el) {
          // Load saved value from appSettings
          const savedValue = appSettings[elementConfig.id];
          if (savedValue !== undefined && savedValue !== null && savedValue !== '') {
            el.value = savedValue;
          }

          // Special handling for select elements to trigger dependent UI updates
          if (elementConfig.type === 'select') {
            setTimeout(() => {
              const event = new Event('change', { bubbles: true });
              el.dispatchEvent(event);
            }, 0);
          }
          
          // Attach saver
          const eventType = (el.tagName === 'SELECT' || elementConfig.type === 'select') ? 'change' : 'input';
          el.addEventListener(eventType, async () => { // Already async, ensure it's correct
            appSettings[el.id] = el.value;
            await window.electronAPI.saveSettings(appSettings);
          });
        }
      });
    }

    loadAndApplySettings(); // Call the main function to load settings

  })
</script>

<!-- Toast Notification Container -->
<div id="toastContainer" class="toast-container">
  <!-- Toasts will be dynamically added here by JavaScript -->
</div>
</body>
</html>
