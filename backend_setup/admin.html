<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>反馈管理面板</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f4f4f9; margin: 0; padding: 20px; }
        #app { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #444; }
        .feedback-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; transition: box-shadow 0.3s ease; }
        .feedback-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .feedback-header { font-size: 0.8em; color: #777; margin-bottom: 10px; }
        .feedback-header span { margin-right: 15px; }
        .feedback-content { margin-bottom: 15px; white-space: pre-wrap; }
        .status-new { color: #007bff; font-weight: bold; }
        .status-replied { color: #28a745; font-weight: bold; }
        .reply-section { margin-top: 10px; }
        textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; min-height: 60px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .replied-text { background-color: #e9f7ef; border-left: 3px solid #28a745; padding: 10px; margin-top: 10px; border-radius: 4px; }
        .loading, .error { text-align: center; padding: 20px; font-size: 1.2em; color: #777; }
    </style>
</head>
<body>

<div id="app">
    <h1>反馈管理面板</h1>

    <div v-if="loading" class="loading">正在加载反馈...</div>
    <div v-if="error" class="error">{{ error }}</div>

    <div v-if="!loading && !error">
        <div v-for="item in feedback" :key="item.id" class="feedback-item">
            <div class="feedback-header">
                <span><strong>ID:</strong> {{ item.id.substring(0, 8) }}</span>
                <span><strong>时间:</strong> {{ new Date(item.timestamp).toLocaleString() }}</span>
                <span><strong>状态:</strong> <span :class="'status-' + item.status">{{ item.status === 'new' ? '新反馈' : '已回复' }}</span></span>
                <span><strong>客户端ID:</strong> {{ item.clientId.substring(0, 8) }}...</span>
            </div>
            <div class="feedback-content">
                <p>{{ item.feedback }}</p>
            </div>

            <div class="reply-section">
                <div v-if="item.reply" class="replied-text">
                    <strong>您的回复 ({{ new Date(item.reply.repliedAt).toLocaleString() }}):</strong>
                    <p>{{ item.reply.content }}</p>
                </div>
                <div v-else>
                    <textarea v-model="item.replyText" placeholder="在此输入您的回复..."></textarea>
                    <button @click="submitReply(item)" :disabled="!item.replyText">提交回复</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                feedback: [],
                loading: true,
                error: null,
                apiUrl: '' // API URL will be set on mount
            };
        },
        methods: {
            async fetchFeedback() {
                this.loading = true;
                this.error = null;
                try {
                    const response = await fetch(`${this.apiUrl}/api/feedback`);
                    if (!response.ok) {
                        throw new Error(`服务器错误: ${response.statusText}`);
                    }
                    const data = await response.json();
                    this.feedback = data.map(item => ({ ...item, replyText: '' }));
                } catch (e) {
                    this.error = `无法加载反馈数据: ${e.message}`;
                    console.error(e);
                } finally {
                    this.loading = false;
                }
            },
            async submitReply(item) {
                if (!item.replyText.trim()) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}/api/feedback/${item.id}/reply`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ reply: item.replyText }),
                    });

                    if (!response.ok) {
                        throw new Error('回复失败');
                    }
                    
                    // 刷新数据以显示回复
                    await this.fetchFeedback();

                } catch (e) {
                    alert(`提交回复时出错: ${e.message}`);
                    console.error(e);
                }
            }
        },
        mounted() {
            // 动态设置API URL，使其在本地和服务器上都能工作
            this.apiUrl = `${window.location.protocol}//${window.location.hostname}:${window.location.port || (window.location.protocol === 'https' ? 443 : 80)}`;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                this.apiUrl = 'http://localhost:3000'; // 本地开发时强制使用3000端口
            }
            this.fetchFeedback();
        }
    }).mount('#app');
</script>

</body>
</html>